<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Ponto - Painel RH</title>
    <link rel="stylesheet" href="style_dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" />
</head>

<body class="page-rh">

    <div class="theme-switch-wrapper">
        <i class="fas fa-sun icon"></i>
        <label class="theme-switch">
            <input type="checkbox" id="theme-toggle">
            <span class="slider"></span>
        </label>
        <i class="fas fa-moon icon"></i>
    </div>

    <aside class="sidebar">
        <div class="sidebar-logo">
            <h1><span class="smart">Smart</span><span class="ponto">Ponto</span></h1>
        </div>

        <nav class="sidebar-nav">
            <ul>
                <li><a href="rh_dashboard.html" class="active"><i class="fas fa-home"></i> Início</a></li>

                <li class="dropdown">
                    <a href="#" class="dropdown-toggle"><i class="fas fa-edit"></i> Cadastros <i
                            class="fas fa-chevron-down"></i></a>
                    <ul class="dropdown-menu">
                        <li><a href="#" id="btn-cadastro-funcionario">Novo Funcionário</a></li>
                        <li><a href="#" id="btn-cad-departamentos">Departamentos</a></li>
                        <li><a href="#" id="btn-cad-jornadas">Jornada de trabalho</a></li>
                    </ul>
                </li>

                <li class="dropdown">
                    <a href="#" class="dropdown-toggle"><i class="fas fa-file-invoice"></i> Folha <i
                            class="fas fa-chevron-down"></i></a>
                    <ul class="dropdown-menu">
                        <li><a href="#" id="btn-folha-aprovacoes">Aprovações</a></li>
                        <li><a href="#" id="btn-folha-lancamentos">Lançamentos</a></li>
                        <li><a href="#" id="btn-folha-relatorios">Relatórios</a></li>
                    </ul>
                </li>

                <li><a href="#" id="btn-listar-funcionarios"><i class="fas fa-users"></i> Funcionários</a></li>
                <li><a href="#" id="btn-rh-banco-horas"><i class="fas fa-chart-bar"></i> Banco de horas</a></li>
            </ul>
        </nav>

        <div class="sidebar-logout">
            <a href="#" id="btn-logout"><i class="fas fa-sign-out-alt"></i> Sair</a>
        </div>
    </aside>

    <main class="main-content-area">

        <div class="welcome-header">
            <h1 id="slogan-nome-usuario">Painel de Recursos Humanos</h1>
        </div>

        <div class="dashboard-grid">

            <div class="ponto-module-container grid-col-span-2">
                <h3>Meu registro de hoje (<span id="data-hoje"></span>)</h3>
                <div class="ponto-grid">
                    <div class="ponto-card" id="card-entrada"><i
                            class="fas fa-right-to-bracket"></i><label>Entrada</label><span
                            class="ponto-previsto"></span><span id="time-entrada" class="ponto-time">--:--</span></div>
                    <div class="ponto-card" id="card-pausa"><i class="fas fa-mug-saucer"></i><label>Pausa</label><span
                            class="ponto-previsto"></span><span id="time-pausa" class="ponto-time">--:--</span></div>
                    <div class="ponto-card" id="card-retorno"><i class="fas fa-laptop"></i><label>Retorno</label><span
                            id="retorno-previsto" class="ponto-previsto"></span><span id="time-retorno"
                            class="ponto-time">--:--</span></div>
                    <div class="ponto-card" id="card-saida"><i
                            class="fas fa-right-from-bracket"></i><label>Saída</label><span
                            class="ponto-previsto"></span><span id="time-saida" class="ponto-time">--:--</span></div>
                </div>
                <div id="aviso-jornada" class="aviso-jornada" style="display: none;"></div>
                <button class="ponto-btn" id="btn-bater-ponto"><i class="fas fa-clock"></i> Bater Ponto</button>
                <p id="ponto-loading" class="ponto-loading-text" style="display: none;"><i
                        class="fas fa-spinner fa-spin"></i> Obtendo localização, aguarde...</p>
            </div>

            <div class="summary-card">
                <div class="summary-card-header">
                    <i class="fas fa-users"></i>
                    <span>Total de Funcionários</span>
                </div>
                <div class="summary-card-body">
                    <h2 class="value" id="widget-total-func">0</h2>
                    <p class="label">Usuários cadastrados</p>
                </div>
            </div>

            <div class="summary-card">
                <div class="summary-card-header">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Ajustes Pendentes</span>
                </div>
                <div class="summary-card-body">
                    <h2 class="value" id="widget-ajustes-pendentes">0</h2>
                    <p class="label">Solicitações na empresa</p>
                </div>
            </div>

            <div class="summary-card grid-col-span-2">
                <div class="summary-card-header">
                    <i class="fas fa-chart-bar"></i>
                    <span>Banco de Horas (Empresa)</span>
                </div>
                <div class="summary-card-body">
                    <h2 class="value" id="widget-saldo-empresa">00h 00m</h2>
                    <p class="label">Saldo total de horas da empresa</p>
                </div>
            </div>

        </div>

        <div id="aprovacoes-rh-container" class="panel-container" style="display: none;">
            <h2>Gerenciar Solicitações (Toda Empresa)</h2>
            <p>Visualize e gerencie as solicitações de ajuste de ponto pendentes.</p>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Funcionário</th>
                        <th>Data</th>
                        <th>Tipo</th>
                        <th>Justificativa</th>
                        <th style="width: 200px;">Ações</th>
                    </tr>
                </thead>
                <tbody id="aprovacoes-rh-table-body">
                </tbody>
            </table>
            <div class="button-group">
                <button type="button" class="cancel-btn" id="btn-fechar-aprovacoes-rh">Fechar</button>
            </div>
        </div>

        <div id="form-container-cadastro" class="panel-container">
            <form id="form-cadastro">
                <h2>Cadastro de Novo Funcionário</h2>
                <h3>Dados Pessoais</h3>
                <div class="form-row">
                    <div class="form-group"><label for="nome">Nome Completo:</label><input type="text" id="nome"
                            name="nome" required placeholder="Ex: Maria Souza"></div>
                    <div class="form-group"><label for="cpf">CPF:</label><input type="text" id="cpf" name="cpf" required
                            placeholder="000.000.000-00"></div>
                </div>
                <hr>
                <h3>Dados de Acesso</h3>
                <div class="form-row">
                    <div class="form-group"><label for="email">Email Corporativo (Login):</label><input type="email"
                            id="email" name="email" required placeholder="maria.souza@smartponto.com"></div>
                    <div class="form-group"><label for="senha">Senha:</label><input type="password" id="senha"
                            name="senha" required placeholder="Defina uma senha"></div>
                </div>
                <hr>
                <h3>Dados Contratuais</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="perfil">Perfil de Acesso:</label>
                        <select id="perfil" name="perfil" required>
                            <option value="">Selecione o perfil</option>
                            <option value="funcionario">Funcionário</option>
                            <option value="gestor">Gestor</option>
                        </select>
                    </div>
                    <div class="form-group"><label for="cargo">Cargo:</label><input type="text" id="cargo" name="cargo"
                            placeholder="Ex: Analista de Sistemas Jr."></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="departamento">Departamento:</label>
                        <select id="departamento" name="departamento" required>
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="jornada">Jornada de Trabalho:</label>
                        <select id="jornada" name="jornada" required>
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="salario">Salário (R$):</label>
                        <input type="number" id="salario" name="salario" step="0.01" min="0" placeholder="Ex: 3500.50">
                    </div>
                    <div class="form-group">
                    </div>
                </div>
                <div class="button-group">
                    <button type="button" class="cancel-btn" id="btn-cancelar-form">Cancelar</button>
                    <button type="submit" class="submit-btn"><i class="fas fa-plus-circle"></i> Cadastrar
                        Funcionário</button>
                </div>
            </form>
        </div>

        <div id="lista-container-usuarios" class="panel-container">
            <h2>Usuários Cadastrados</h2>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Email (Login)</th>
                        <th>Perfil</th>
                        <th>Departamento</th>
                        <th>Jornada</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody id="user-table-body"></tbody>
            </table>
            <div class="button-group">
                <button type="button" class="cancel-btn" id="btn-fechar-lista">Fechar</button>
            </div>
        </div>

        <div id="departamentos-container" class="panel-container">
            <h2>Gestão de Departamentos</h2>
            <form id="form-novo-departamento">
                <h3>Cadastrar Novo Departamento</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="nome-departamento">Nome do Departamento:</label>
                        <input type="text" id="nome-departamento" placeholder="Ex: Financeiro" required>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="submit" class="submit-btn"><i class="fas fa-plus"></i> Adicionar</button>
                    </div>
                </div>
            </form>
            <hr>
            <h3>Departamentos Cadastrados</h3>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th style="width: 100px;">Ação</th>
                    </tr>
                </thead>
                <tbody id="departamentos-table-body">
                </tbody>
            </table>
            <div class="button-group">
                <button type="button" class="cancel-btn" id="btn-fechar-departamentos">Fechar</button>
            </div>
        </div>

        <div id="jornadas-container" class="panel-container">
            <h2>Gestão de Jornadas de Trabalho</h2>
            <form id="form-nova-jornada">
                <h3>Cadastrar Nova Jornada</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="jornada-nome">Nome da Jornada:</label>
                        <input type="text" id="jornada-nome" placeholder="Ex: Horário Comercial (Sexta Curta)" required>
                    </div>
                    <div class="form-group">
                        <label for="jornada-almoco">Almoço (minutos):</label>
                        <input type="number" id="jornada-almoco" placeholder="Ex: 60" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="jornada-inicio">Início (Seg-Qui):</label>
                        <input type="time" id="jornada-inicio" required>
                    </div>
                    <div class="form-group">
                        <label for="jornada-fim">Fim (Seg-Qui):</label>
                        <input type="time" id="jornada-fim" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="jornada-inicio-sexta">Início (Sexta):</label>
                        <input type="time" id="jornada-inicio-sexta" required>
                    </div>
                    <div class="form-group">
                        <label for="jornada-fim-sexta">Fim (Sexta):</label>
                        <input type="time" id="jornada-fim-sexta" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <button type="submit" class="submit-btn"><i class="fas fa-plus"></i> Adicionar Jornada</button>
                    </div>
                </div>
            </form>
            <hr>
            <h3>Jornadas Cadastradas</h3>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Seg-Qui</th>
                        <th>Sexta</th>
                        <th>Almoço</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody id="jornadas-table-body">
                </tbody>
            </table>
            <div class="button-group">
                <button type="button" class="cancel-btn" id="btn-fechar-jornadas">Fechar</button>
            </div>
        </div>

        <div id="lancamentos-container" class="panel-container">
            <h2>Lançamento Manual de Ponto</h2>
            <form id="form-lancamento">
                <div class="form-row">
                    <div class="form-group">
                        <label for="select-funcionario-lancamento">Funcionário:</label>
                        <select id="select-funcionario-lancamento" required>
                            <option value="">Selecione um funcionário...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lancamento-data">Data da Batida:</label>
                        <input type="date" id="lancamento-data" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="lancamento-tipo">Tipo de Batida:</label>
                        <select id="lancamento-tipo" required>
                            <option value="">Selecione o tipo...</option>
                            <option value="entrada">Entrada</option>
                            <option value="pausa">Pausa</option>
                            <option value="retorno">Retorno</option>
                            <option value="saida">Saída</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lancamento-hora">Hora da Batida:</label>
                        <input type="time" id="lancamento-hora" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="lancamento-justificativa">Justificativa:</label>
                        <textarea id="lancamento-justificativa" rows="3" placeholder="Ex: Correção de esquecimento."
                            required></textarea>
                    </div>
                </div>
                <div class="button-group">
                    <button type="button" class="cancel-btn" id="btn-fechar-lancamentos">Cancelar</button>
                    <button type="submit" class="submit-btn"><i class="fas fa-save"></i> Salvar Lançamento</button>
                </div>
            </form>
        </div>

        <div id="relatorios-container" class="panel-container">
            <h2>Relatório de Batidas</h2>
            <p>Selecione um funcionário para visualizar e exportar seu histórico, ou exporte o relatório geral.</p>
            <div class="form-row">
                <div class="form-group">
                    <label for="select-funcionario-relatorio">Filtrar por Funcionário:</label>
                    <select id="select-funcionario-relatorio">
                        <option value="">Selecione um funcionário...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filtro-mes-relatorio">Filtrar por Mês:</label>
                    <select id="filtro-mes-relatorio">
                        <option value="">Selecione um funcionário primeiro</option>
                    </select>
                </div>
            </div>
            <button type="button" class="submit-btn" id="btn-exportar-csv-selecao" disabled>
                <i class="fas fa-file-csv"></i> Exportar Seleção
            </button>
            <button type="button" class="submit-btn" id="btn-exportar-csv-geral"
                style="background: #27ae60; margin-left: 10px;">
                <i class="fas fa-file-csv"></i> Exportar Geral
            </button>
            <hr>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Entrada</th>
                        <th>Pausa</th>
                        <th>Retorno</th>
                        <th>Saída</th>
                    </tr>
                </thead>
                <tbody id="relatorios-table-body">
                    <tr>
                        <td colspan="5">Selecione um funcionário acima.</td>
                    </tr>
                </tbody>
            </table>
            <div class="button-group">
                <button type="button" class="cancel-btn" id="btn-fechar-relatorios">Fechar</button>
            </div>
        </div>

        <div id="rh-banco-horas-container" class="panel-container">
            <h2>Relatório Geral de Banco de Horas</h2>
            <p>Este é o saldo total de horas de todos os funcionários da empresa.</p>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Funcionário</th>
                        <th>Departamento</th>
                        <th>Saldo Total</th>
                    </tr>
                </thead>
                <tbody id="rh-banco-horas-table-body">
                </tbody>
            </table>
            <div class="button-group">
                <button type="button" class="cancel-btn" id="btn-fechar-rh-banco-horas">Fechar</button>
            </div>
        </div>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. SELEÇÃO DE ELEMENTOS ---

            const dadosUsuario = JSON.parse(localStorage.getItem('sessao_usuario_atual'));
            if (!dadosUsuario) { alert('Você não está logado!'); window.location.href = '../login_page/index.html'; return; }

            // Painéis
            const painelGrid = document.querySelector('.dashboard-grid');
            const formContainer = document.getElementById('form-container-cadastro');
            const listaContainer = document.getElementById('lista-container-usuarios');
            const deptContainer = document.getElementById('departamentos-container');
            const jornadasContainer = document.getElementById('jornadas-container');
            const lancamentosContainer = document.getElementById('lancamentos-container');
            const relatoriosContainer = document.getElementById('relatorios-container');
            const rhBancoHorasContainer = document.getElementById('rh-banco-horas-container');
            const aprovacoesRhContainer = document.getElementById('aprovacoes-rh-container');

            // Botões da Sidebar
            const btnCadastro = document.getElementById('btn-cadastro-funcionario');
            const btnListar = document.getElementById('btn-listar-funcionarios');
            const btnCadDepartamentos = document.getElementById('btn-cad-departamentos');
            const btnCadJornadas = document.getElementById('btn-cad-jornadas');
            const btnFolhaLancamentos = document.getElementById('btn-folha-lancamentos');
            const btnFolhaRelatorios = document.getElementById('btn-folha-relatorios');
            const btnFolhaAprovacoes = document.getElementById('btn-folha-aprovacoes');
            const btnRhBancoHoras = document.getElementById('btn-rh-banco-horas');
            const btnLogout = document.getElementById('btn-logout');

            // Botões de Fechar
            const btnCancelForm = document.getElementById('btn-cancelar-form');
            const btnFecharLista = document.getElementById('btn-fechar-lista');
            const btnFecharDept = document.getElementById('btn-fechar-departamentos');
            const btnFecharJornadas = document.getElementById('btn-fechar-jornadas');
            const btnFecharLancamentos = document.getElementById('btn-fechar-lancamentos');
            const btnFecharRelatorios = document.getElementById('btn-fechar-relatorios');
            const btnFecharRhBancoHoras = document.getElementById('btn-fechar-rh-banco-horas');
            const btnFecharAprovacoesRh = document.getElementById('btn-fechar-aprovacoes-rh');

            // Módulo de Ponto
            const dataHojeEl = document.getElementById('data-hoje');
            const btnBaterPonto = document.getElementById('btn-bater-ponto');
            const loadingText = document.getElementById('ponto-loading');
            const retornoPrevistoEl = document.getElementById('retorno-previsto');
            const avisoJornadaEl = document.getElementById('aviso-jornada');
            const timeSpans = { entrada: document.getElementById('time-entrada'), pausa: document.getElementById('time-pausa'), retorno: document.getElementById('time-retorno'), saida: document.getElementById('time-saida') };
            const cards = { entrada: document.getElementById('card-entrada'), pausa: document.getElementById('card-pausa'), retorno: document.getElementById('card-retorno'), saida: document.getElementById('card-saida') };

            // Widgets
            const widgetTotalFunc = document.getElementById('widget-total-func');
            const widgetAjustesPendentes = document.getElementById('widget-ajustes-pendentes');
            const widgetSaldoEmpresa = document.getElementById('widget-saldo-empresa');

            // Elementos dos Painéis
            const formCadastroFunc = document.getElementById('form-cadastro');
            const tableBodyFunc = document.getElementById('user-table-body');
            const selectDepartamento = document.getElementById('departamento');
            const selectJornada = document.getElementById('jornada');
            const formDept = document.getElementById('form-novo-departamento');
            const inputDept = document.getElementById('nome-departamento');
            const tableBodyDept = document.getElementById('departamentos-table-body');
            const formJornada = document.getElementById('form-nova-jornada');
            const tableBodyJornadas = document.getElementById('jornadas-table-body');
            const formLancamento = document.getElementById('form-lancamento');
            const selectFuncionarioLancamento = document.getElementById('select-funcionario-lancamento');
            const selectFuncionarioRelatorio = document.getElementById('select-funcionario-relatorio');
            const filtroMesRelatorio = document.getElementById('filtro-mes-relatorio');
            const relatoriosTableBody = document.getElementById('relatorios-table-body');
            const btnExportarCsvSelecao = document.getElementById('btn-exportar-csv-selecao');
            const btnExportarCsvGeral = document.getElementById('btn-exportar-csv-geral');
            const rhBancoHorasTableBody = document.getElementById('rh-banco-horas-table-body');
            const aprovacoesRhTableBody = document.getElementById('aprovacoes-rh-table-body');

            // Chaves
            const storageKeyUsuarios = 'usuarios_smartponto';
            const storageKeyDept = 'departamentos_smartponto';
            const storageKeyJornadas = 'jornadas_smartponto';
            const storageKeyBatidas = 'batidas_smartponto';
            const storageKeySolicitacoes = 'solicitacoes_smartponto';

            // Init
            const sloganNomeUsuario = document.getElementById('slogan-nome-usuario');
            sloganNomeUsuario.textContent = `Bem-vindo(a), ${dadosUsuario.nome}`;
            dataHojeEl.textContent = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });


            // --- 2. FUNÇÕES AUXILIARES ---

            function fecharTodosPaineis() {
                formContainer.style.display = 'none';
                listaContainer.style.display = 'none';
                deptContainer.style.display = 'none';
                jornadasContainer.style.display = 'none';
                lancamentosContainer.style.display = 'none';
                relatoriosContainer.style.display = 'none';
                rhBancoHorasContainer.style.display = 'none';
                aprovacoesRhContainer.style.display = 'none';
                painelGrid.style.display = 'grid';
            }

            function abrirPainel(painel) {
                painelGrid.style.display = 'none';
                fecharTodosPaineis();
                painel.style.display = 'block';
            }

            function horaParaMinutos(horaStr) { if (!horaStr) return 0; const [horas, minutos] = horaStr.split(':').map(Number); return (horas * 60) + minutos; }
            function minutosParaHora(minutosTotais) { const sinal = minutosTotais < 0 ? '-' : ''; const minAbs = Math.abs(minutosTotais); const horas = Math.floor(minAbs / 60); const minutos = minAbs % 60; const horasStr = String(horas).padStart(2, '0'); const minutosStr = String(minutos).padStart(2, '0'); return `${sinal}${horasStr}h ${minutosStr}m`; }

            function popularDropdownTodosFuncionarios(selectElement) {
                let usuarios = JSON.parse(localStorage.getItem(storageKeyUsuarios)) || [];
                const funcionarios = usuarios.filter(u => u.email !== dadosUsuario.email);
                selectElement.innerHTML = '<option value="">Selecione um funcionário...</option>';
                if (funcionarios.length === 0) { selectElement.innerHTML = '<option value="">Nenhum funcionário cadastrado.</option>'; return; }
                funcionarios.forEach(func => {
                    const option = document.createElement('option');
                    option.value = func.email;
                    option.textContent = `${func.nome} (${func.departamento || 'N/D'})`;
                    selectElement.appendChild(option);
                });
            }
            function popularDropdownsCadastro() {
                selectDepartamento.innerHTML = '<option value="">Selecione o departamento</option>';
                selectJornada.innerHTML = '<option value="">Selecione a jornada</option>';
                const departamentos = JSON.parse(localStorage.getItem(storageKeyDept)) || [];
                departamentos.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.nome;
                    option.textContent = dept.nome;
                    selectDepartamento.appendChild(option);
                });
                const jornadas = JSON.parse(localStorage.getItem(storageKeyJornadas)) || [];
                jornadas.forEach(j => {
                    const option = document.createElement('option');
                    option.value = j.nome;
                    option.textContent = `${j.nome} (Seg-Qui: ${j.inicio}-${j.fim} | Sex: ${j.inicioSexta}-${j.fimSexta})`;
                    selectJornada.appendChild(option);
                });
            }

            // --- 3. FUNÇÕES PRINCIPAIS ---

            function renderizarAprovacoesRH() {
                let solicitacoes = JSON.parse(localStorage.getItem(storageKeySolicitacoes)) || [];
                let usuarios = JSON.parse(localStorage.getItem(storageKeyUsuarios)) || [];
                const pendentes = solicitacoes.filter(s => s.status === 'pendente');
                aprovacoesRhTableBody.innerHTML = '';
                if (pendentes.length === 0) {
                    aprovacoesRhTableBody.innerHTML = '<tr><td colspan="5">Nenhuma solicitação pendente na empresa.</td></tr>';
                    return;
                }
                const mapaNomes = {};
                usuarios.forEach(u => { mapaNomes[u.email] = u.nome; });
                mapaNomes["rh@smartponto.com.br"] = "Admin RH (Padrão)";
                mapaNomes["gestor@smartponto.com.br"] = "Gestor (Padrão)";
                mapaNomes["funcionario@smartponto.com.br"] = "Funcionário (Padrão)";

                pendentes.forEach(solicitacao => {
                    const nomeUsuario = mapaNomes[solicitacao.emailUsuario] || solicitacao.emailUsuario;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${nomeUsuario}</td><td>${new Date(solicitacao.data).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</td><td>${solicitacao.tipo.replace('_', ' ')}</td><td>${solicitacao.justificativa}</td><td><button class="approve-btn" data-id="${solicitacao.id}"><i class="fas fa-check"></i> Aprovar</button><button class="reject-btn" data-id="${solicitacao.id}"><i class="fas fa-times"></i> Recusar</button></td>`;
                    aprovacoesRhTableBody.appendChild(tr);
                });
            }

            function atualizarStatusSolicitacao(id, novoStatus) {
                let solicitacoes = JSON.parse(localStorage.getItem(storageKeySolicitacoes)) || [];
                const index = solicitacoes.findIndex(s => s.id == id);
                if (index !== -1) {
                    const solicitacao = solicitacoes[index];
                    solicitacao.status = novoStatus;
                    if (novoStatus === 'aprovado') {
                        let tipoBatida = '';
                        if (solicitacao.tipo.includes('entrada')) tipoBatida = 'entrada';
                        else if (solicitacao.tipo.includes('pausa')) tipoBatida = 'pausa';
                        else if (solicitacao.tipo.includes('retorno')) tipoBatida = 'retorno';
                        else if (solicitacao.tipo.includes('saida')) tipoBatida = 'saida';
                        if (tipoBatida) {
                            const novaBatida = {
                                emailUsuario: solicitacao.emailUsuario,
                                data: solicitacao.data,
                                tipo: tipoBatida,
                                hora: solicitacao.horario,
                                local: "Ajuste Aprovado (RH)"
                            };
                            let batidas = JSON.parse(localStorage.getItem(storageKeyBatidas)) || [];
                            batidas = batidas.filter(b => !(b.data === novaBatida.data && b.tipo === novaBatida.tipo && b.emailUsuario === novaBatida.emailUsuario));
                            batidas.push(novaBatida);
                            localStorage.setItem(storageKeyBatidas, JSON.stringify(batidas));
                        }
                    }
                }
                localStorage.setItem(storageKeySolicitacoes, JSON.stringify(solicitacoes));
                renderizarAprovacoesRH();
                atualizarWidgets();
            }

            function renderizarListaUsuarios() {
                let usuarios = JSON.parse(localStorage.getItem(storageKeyUsuarios)) || [];
                tableBodyFunc.innerHTML = '';
                if (usuarios.length === 0) { tableBodyFunc.innerHTML = '<tr><td colspan="6">Nenhum usuário cadastrado ainda.</td></tr>'; return; }
                usuarios.forEach((usuario) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${usuario.nome}</td><td>${usuario.email}</td><td>${usuario.perfil}</td><td>${usuario.departamento || 'N/D'}</td><td>${usuario.jornada || 'N/D'}</td><td><button class="delete-btn" data-email="${usuario.email}"><i class="fas fa-trash-alt"></i> Excluir</button></td>`;
                    tableBodyFunc.appendChild(tr);
                });
            }
            function excluirUsuario(email) {
                if (!confirm(`Tem certeza que deseja excluir o usuário ${email}?`)) { return; }
                let usuarios = JSON.parse(localStorage.getItem(storageKeyUsuarios)) || [];
                const novosUsuarios = usuarios.filter(user => user.email !== email);
                localStorage.setItem(storageKeyUsuarios, JSON.stringify(novosUsuarios));
                renderizarListaUsuarios();
                atualizarWidgets();
            }
            function renderizarDepartamentos() {
                const departamentos = JSON.parse(localStorage.getItem(storageKeyDept)) || [];
                tableBodyDept.innerHTML = '';
                if (departamentos.length === 0) { tableBodyDept.innerHTML = '<tr><td colspan="2">Nenhum departamento cadastrado.</td></tr>'; return; }
                departamentos.forEach((dept) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${dept.nome}</td><td><button class="delete-btn" data-nome="${dept.nome}"><i class="fas fa-trash-alt"></i> Excluir</button></td>`;
                    tableBodyDept.appendChild(tr);
                });
            }
            function renderizarJornadas() {
                const jornadas = JSON.parse(localStorage.getItem(storageKeyJornadas)) || [];
                tableBodyJornadas.innerHTML = '';
                if (jornadas.length === 0) { tableBodyJornadas.innerHTML = '<tr><td colspan="5">Nenhuma jornada cadastrada.</td></tr>'; return; }
                jornadas.forEach((j) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${j.nome}</td><td>${j.inicio} - ${j.fim}</td><td>${j.inicioSexta} - ${j.fimSexta}</td><td>${j.almoco} min</td><td><button class="delete-btn" data-nome="${j.nome}"><i class="fas fa-trash-alt"></i> Excluir</button></td>`;
                    tableBodyJornadas.appendChild(tr);
                });
            }
            function habilitarBotaoPonto() { btnBaterPonto.disabled = false; loadingText.style.display = 'none'; }
            function verificarStatusJornada() {
                const agora = new Date();
                const diaDaSemana = agora.getDay();
                if (!dadosUsuario || !dadosUsuario.jornada) return;
                let horarioFimDaJornada;
                if (diaDaSemana === 5) { horarioFimDaJornada = dadosUsuario.jornada.fimSexta; } else { horarioFimDaJornada = dadosUsuario.jornada.fim; }
                if (!horarioFimDaJornada) return;
                const [fimHora, fimMinuto] = horarioFimDaJornada.split(':').map(Number);
                const horarioSaida = new Date();
                horarioSaida.setHours(fimHora, fimMinuto, 0, 0);
                const estaEmHoraExtra = agora > horarioSaida;
                const naoBateuSaida = timeSpans.saida.textContent === '--:--';
                const jaEntrou = timeSpans.entrada.textContent !== '--:--';
                if (estaEmHoraExtra && naoBateuSaida && jaEntrou) {
                    avisoJornadaEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Seu horário de trabalho regular terminou. A partir de agora, você está em hora extra.';
                    avisoJornadaEl.style.display = 'block';
                } else {
                    avisoJornadaEl.style.display = 'none';
                }
            }

            function renderizarRelatorioFuncionario(emailFuncionario, mesFiltro = null) {
                relatoriosTableBody.innerHTML = '';
                if (!emailFuncionario) {
                    relatoriosTableBody.innerHTML = '<tr><td colspan="5">Selecione um funcionário acima.</td></tr>';
                    btnExportarCsvSelecao.disabled = true;
                    filtroMesRelatorio.innerHTML = '<option value="">Selecione um funcionário primeiro</option>';
                    return;
                }
                let batidas = JSON.parse(localStorage.getItem(storageKeyBatidas)) || [];
                const batidasFuncionario = batidas.filter(b => b.emailUsuario === emailFuncionario);

                // Popula filtro de mês
                if (!mesFiltro) {
                    const mesesDisponiveis = [...new Set(batidasFuncionario.map(b => b.data.substring(0, 7)))];
                    mesesDisponiveis.sort().reverse();
                    filtroMesRelatorio.innerHTML = '';
                    if (mesesDisponiveis.length === 0) { filtroMesRelatorio.innerHTML = '<option value="">Sem dados</option>'; }
                    else {
                        mesesDisponiveis.forEach(mes => {
                            const option = document.createElement('option');
                            option.value = mes;
                            const [ano, mesNum] = mes.split('-');
                            option.textContent = `${mesNum}/${ano}`;
                            filtroMesRelatorio.appendChild(option);
                        });
                        mesFiltro = mesesDisponiveis[0];
                        filtroMesRelatorio.value = mesFiltro;
                    }
                }

                if (batidasFuncionario.length === 0) {
                    relatoriosTableBody.innerHTML = '<tr><td colspan="5">Este funcionário não possui batidas.</td></tr>';
                    btnExportarCsvSelecao.disabled = true;
                    return;
                }
                const batidasPorDia = {};
                batidasFuncionario.forEach(b => {
                    if (b.data.substring(0, 7) === mesFiltro) {
                        if (!batidasPorDia[b.data]) batidasPorDia[b.data] = {};
                        batidasPorDia[b.data][b.tipo] = { hora: b.hora, local: b.local };
                    }
                });
                const datasOrdenadas = Object.keys(batidasPorDia).sort((a, b) => new Date(b) - new Date(a));
                if (datasOrdenadas.length === 0) {
                    relatoriosTableBody.innerHTML = '<tr><td colspan="5">Nenhum registro neste mês.</td></tr>';
                } else {
                    datasOrdenadas.forEach(data => {
                        const dia = batidasPorDia[data];
                        const formatarCelula = (tipo) => {
                            if (!dia[tipo]) return '--:--';
                            const local = dia[tipo].local ? dia[tipo].local.split(',')[0] : 'N/D';
                            return `${dia[tipo].hora}<br><small class="localizacao">${local}</small>`;
                        };
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${new Date(data + 'T12:00:00').toLocaleDateString('pt-BR')}</td><td>${formatarCelula('entrada')}</td><td>${formatarCelula('pausa')}</td><td>${formatarCelula('retorno')}</td><td>${formatarCelula('saida')}</td>`;
                        relatoriosTableBody.appendChild(tr);
                    });
                }
                btnExportarCsvSelecao.disabled = false;
            }

            function exportarCSVSelecao() {
                const emailFuncionario = selectFuncionarioRelatorio.value;
                if (!emailFuncionario) { alert('Selecione um funcionário primeiro.'); return; }
                const nomeFuncionario = selectFuncionarioRelatorio.options[selectFuncionarioRelatorio.selectedIndex].text.split(' (')[0];
                let batidas = JSON.parse(localStorage.getItem(storageKeyBatidas)) || [];
                const batidasFuncionario = batidas.filter(b => b.emailUsuario === emailFuncionario);
                if (batidasFuncionario.length === 0) { alert('Este funcionário não possui batidas para exportar.'); return; }
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Funcionario;Data;Tipo;Hora;Localizacao\n";
                batidasFuncionario.forEach(b => {
                    const local = `"${b.local || 'N/D'}"`;
                    const linha = [nomeFuncionario, b.data, b.tipo, b.hora, local].join(";");
                    csvContent += linha + "\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `relatorio_batidas_${nomeFuncionario}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            function exportarCSVGeral() {
                let batidas = JSON.parse(localStorage.getItem(storageKeyBatidas)) || [];
                let usuarios = JSON.parse(localStorage.getItem(storageKeyUsuarios)) || [];
                if (batidas.length === 0) {
                    alert('Não há nenhuma batida registrada no sistema para exportar.');
                    return;
                }
                const mapaNomes = {};
                usuarios.forEach(u => { mapaNomes[u.email] = u.nome; });
                mapaNomes[dadosUsuario.email] = dadosUsuario.nome;
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Funcionario;Data;Tipo;Hora;Localizacao\n";
                batidas.forEach(b => {
                    const nomeFuncionario = mapaNomes[b.emailUsuario] || b.emailUsuario;
                    const local = `"${b.local || 'N/D'}"`;
                    const linha = [nomeFuncionario, b.data, b.tipo, b.hora, local].join(";");
                    csvContent += linha + "\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `relatorio_geral_batidas.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            function renderizarBancoHorasGeral() {
                rhBancoHorasTableBody.innerHTML = '<tr><td colspan="3">Calculando saldos...</td></tr>';
                let usuarios = JSON.parse(localStorage.getItem(storageKeyUsuarios)) || [];
                let jornadas = JSON.parse(localStorage.getItem(storageKeyJornadas)) || [];
                let batidas = JSON.parse(localStorage.getItem(storageKeyBatidas)) || [];
                const funcionarios = usuarios.filter(u => u.email !== dadosUsuario.email);
                if (funcionarios.length === 0) {
                    rhBancoHorasTableBody.innerHTML = '<tr><td colspan="3">Nenhum funcionário cadastrado.</td></tr>';
                    return;
                }
                rhBancoHorasTableBody.innerHTML = '';
                funcionarios.forEach(func => {
                    const jornadaDoFuncionario = jornadas.find(j => j.nome === func.jornada);
                    const batidasFuncionario = batidas.filter(b => b.emailUsuario === func.email);
                    let saldoTotalMinutos = 0;
                    if (jornadaDoFuncionario && batidasFuncionario.length > 0) {
                        const batidasPorDia = {};
                        batidasFuncionario.forEach(b => {
                            if (!batidasPorDia[b.data]) batidasPorDia[b.data] = {};
                            batidasPorDia[b.data][b.tipo] = b.hora;
                        });
                        Object.keys(batidasPorDia).forEach(data => {
                            const dia = batidasPorDia[data];
                            const dataObj = new Date(data + 'T12:00:00');
                            const diaDaSemana = dataObj.getDay();
                            let jornadaEsperadaMin = 0;
                            if (diaDaSemana === 5) {
                                jornadaEsperadaMin = (horaParaMinutos(jornadaDoFuncionario.fimSexta) - horaParaMinutos(jornadaDoFuncionario.inicioSexta)) - jornadaDoFuncionario.almoco;
                            } else if (diaDaSemana !== 0 && diaDaSemana !== 6) {
                                jornadaEsperadaMin = (horaParaMinutos(jornadaDoFuncionario.fim) - horaParaMinutos(jornadaDoFuncionario.inicio)) - jornadaDoFuncionario.almoco;
                            }
                            if (isNaN(jornadaEsperadaMin)) jornadaEsperadaMin = 0;
                            let totalTrabalhadoMin = 0;
                            if (dia.entrada && dia.saida) {
                                const entrada = horaParaMinutos(dia.entrada);
                                const saida = horaParaMinutos(dia.saida);
                                const pausa = horaParaMinutos(dia.pausa);
                                const retorno = horaParaMinutos(dia.retorno);
                                const tempoPausa = (retorno > 0 && pausa > 0) ? (retorno - pausa) : 0;
                                totalTrabalhadoMin = (saida - entrada) - tempoPausa;
                            }
                            saldoTotalMinutos += (totalTrabalhadoMin - jornadaEsperadaMin);
                        });
                    }
                    const tr = document.createElement('tr');
                    const saldoTotalStr = minutosParaHora(saldoTotalMinutos);
                    let saldoClasse = 'status-neutro';
                    if (saldoTotalMinutos > 0) saldoClasse = 'status-aprovado';
                    if (saldoTotalMinutos < 0) saldoClasse = 'status-recusado';
                    tr.innerHTML = `
                        <td>${func.nome}</td>
                        <td>${func.departamento || 'N/D'}</td>
                        <td><span class="status-badge ${saldoClasse}">${saldoTotalStr}</span></td>
                    `;
                    rhBancoHorasTableBody.appendChild(tr);
                });
            }

            // --- EVENT LISTENERS ---
            btnCadastro.addEventListener('click', (event) => { event.preventDefault(); abrirPainel(formContainer); popularDropdownsCadastro(); });
            btnListar.addEventListener('click', (event) => { event.preventDefault(); abrirPainel(listaContainer); renderizarListaUsuarios(); });
            btnCadDepartamentos.addEventListener('click', (event) => { event.preventDefault(); abrirPainel(deptContainer); renderizarDepartamentos(); });
            btnCadJornadas.addEventListener('click', (event) => { event.preventDefault(); abrirPainel(jornadasContainer); renderizarJornadas(); });
            btnFolhaLancamentos.addEventListener('click', (event) => { event.preventDefault(); abrirPainel(lancamentosContainer); popularDropdownTodosFuncionarios(selectFuncionarioLancamento); });
            btnFolhaRelatorios.addEventListener('click', (event) => {
                event.preventDefault();
                abrirPainel(relatoriosContainer);
                popularDropdownTodosFuncionarios(selectFuncionarioRelatorio);
                renderizarRelatorioFuncionario(null);
            });
            btnFolhaAprovacoes.addEventListener('click', (event) => { event.preventDefault(); abrirPainel(aprovacoesRhContainer); renderizarAprovacoesRH(); });
            btnRhBancoHoras.addEventListener('click', (event) => { event.preventDefault(); abrirPainel(rhBancoHorasContainer); renderizarBancoHorasGeral(); });

            btnCancelForm.addEventListener('click', fecharTodosPaineis);
            btnFecharLista.addEventListener('click', fecharTodosPaineis);
            btnFecharDept.addEventListener('click', fecharTodosPaineis);
            btnFecharJornadas.addEventListener('click', fecharTodosPaineis);
            btnFecharLancamentos.addEventListener('click', fecharTodosPaineis);
            btnFecharRelatorios.addEventListener('click', fecharTodosPaineis);
            btnFecharRhBancoHoras.addEventListener('click', fecharTodosPaineis);
            btnFecharAprovacoesRh.addEventListener('click', fecharTodosPaineis);

            selectFuncionarioRelatorio.addEventListener('change', (event) => { renderizarRelatorioFuncionario(event.target.value); });
            filtroMesRelatorio.addEventListener('change', (event) => { renderizarRelatorioFuncionario(selectFuncionarioRelatorio.value, event.target.value); });
            btnExportarCsvSelecao.addEventListener('click', exportarCSVSelecao);
            btnExportarCsvGeral.addEventListener('click', exportarCSVGeral);

            aprovacoesRhTableBody.addEventListener('click', (event) => {
                const approveButton = event.target.closest('.approve-btn');
                const rejectButton = event.target.closest('.reject-btn');
                if (approveButton) { atualizarStatusSolicitacao(approveButton.getAttribute('data-id'), 'aprovado'); }
                if (rejectButton) { atualizarStatusSolicitacao(rejectButton.getAttribute('data-id'), 'recusado'); }
            });

            // Lógica do Botão Sair
            btnLogout.addEventListener('click', (event) => {
                event.preventDefault();
                localStorage.removeItem('sessao_usuario_atual');
                window.location.href = 'index.html'; // Caminho corrigido
            });

            // Eventos de formulários e ponto...
            formCadastroFunc.addEventListener('submit', (event) => { event.preventDefault(); const nomeFuncionario = document.getElementById('nome').value; const email = document.getElementById('email').value; const senha = document.getElementById('senha').value; const perfil = document.getElementById('perfil').value; const departamento = document.getElementById('departamento').value; const jornada = document.getElementById('jornada').value; const novoUsuario = { nome: nomeFuncionario, email: email, senha: senha, perfil: perfil, departamento: departamento, jornada: jornada }; let usuarios = JSON.parse(localStorage.getItem(storageKeyUsuarios)) || []; const emailJaExiste = usuarios.some(user => user.email === email); if (emailJaExiste) { alert('Erro: Este email já foi cadastrado!'); return; } usuarios.push(novoUsuario); localStorage.setItem(storageKeyUsuarios, JSON.stringify(usuarios)); alert('Usuário "' + nomeFuncionario + '" cadastrado com sucesso!'); fecharTodosPaineis(); formCadastroFunc.reset(); atualizarWidgets(); });
            tableBodyFunc.addEventListener('click', (event) => { const deleteButton = event.target.closest('.delete-btn'); if (deleteButton) { excluirUsuario(deleteButton.getAttribute('data-email')); } });
            formDept.addEventListener('submit', (event) => { event.preventDefault(); const nomeDept = inputDept.value.trim(); if (!nomeDept) { alert('Por favor, digite um nome para o departamento.'); return; } let departamentos = JSON.parse(localStorage.getItem(storageKeyDept)) || []; const jaExiste = departamentos.some(dept => dept.nome.toLowerCase() === nomeDept.toLowerCase()); if (jaExiste) { alert('Este departamento já existe!'); return; } departamentos.push({ nome: nomeDept }); localStorage.setItem(storageKeyDept, JSON.stringify(departamentos)); inputDept.value = ''; renderizarDepartamentos(); atualizarWidgets(); });
            tableBodyDept.addEventListener('click', (event) => { const deleteButton = event.target.closest('.delete-btn'); if (deleteButton) { const nomeParaExcluir = deleteButton.getAttribute('data-nome'); if (confirm(`Tem certeza que deseja excluir o departamento "${nomeParaExcluir}"?`)) { let departamentos = JSON.parse(localStorage.getItem(storageKeyDept)) || []; const novaLista = departamentos.filter(dept => dept.nome !== nomeParaExcluir); localStorage.setItem(storageKeyDept, JSON.stringify(novaLista)); renderizarDepartamentos(); atualizarWidgets(); } } });
            formJornada.addEventListener('submit', (event) => { event.preventDefault(); const nome = document.getElementById('jornada-nome').value.trim(); const almoco = document.getElementById('jornada-almoco').value; const inicio = document.getElementById('jornada-inicio').value; const fim = document.getElementById('jornada-fim').value; const inicioSexta = document.getElementById('jornada-inicio-sexta').value; const fimSexta = document.getElementById('jornada-fim-sexta').value; if (!nome || !almoco || !inicio || !fim || !inicioSexta || !fimSexta) { alert('Por favor, preencha todos os campos da jornada.'); return; } let jornadas = JSON.parse(localStorage.getItem(storageKeyJornadas)) || []; const jaExiste = jornadas.some(j => j.nome.toLowerCase() === nome.toLowerCase()); if (jaExiste) { alert('Já existe uma jornada com este nome.'); return; } jornadas.push({ nome: nome, almoco: almoco, inicio: inicio, fim: fim, inicioSexta: inicioSexta, fimSexta: fimSexta }); localStorage.setItem(storageKeyJornadas, JSON.stringify(jornadas)); formJornada.reset(); renderizarJornadas(); atualizarWidgets(); });
            tableBodyJornadas.addEventListener('click', (event) => { const deleteButton = event.target.closest('.delete-btn'); if (deleteButton) { const nomeParaExcluir = deleteButton.getAttribute('data-nome'); if (confirm(`Tem certeza que deseja excluir a jornada "${nomeParaExcluir}"?`)) { let jornadas = JSON.parse(localStorage.getItem(storageKeyJornadas)) || []; const novaLista = jornadas.filter(j => j.nome !== nomeParaExcluir); localStorage.setItem(storageKeyJornadas, JSON.stringify(novaLista)); renderizarJornadas(); atualizarWidgets(); } } });
            formLancamento.addEventListener('submit', (event) => { event.preventDefault(); const emailUsuario = document.getElementById('select-funcionario-lancamento').value; const data = document.getElementById('lancamento-data').value; const tipo = document.getElementById('lancamento-tipo').value; const hora = document.getElementById('lancamento-hora').value; const justificativa = document.getElementById('lancamento-justificativa').value; if (!emailUsuario || !data || !tipo || !hora) { alert('Por favor, preencha todos os campos.'); return; } const batida = { emailUsuario: emailUsuario, data: data, tipo: tipo, hora: hora, local: `Lançamento Manual (RH: ${dadosUsuario.nome}) - ${justificativa}` }; let batidas = JSON.parse(localStorage.getItem(storageKeyBatidas)) || []; const jaExiste = batidas.find(b => b.data === data && b.tipo === tipo && b.emailUsuario === emailUsuario); if (jaExiste) { if (!confirm(`O funcionário já possui uma batida de "${tipo}" no dia ${data}. Deseja sobrescrever?`)) { return; } batidas = batidas.filter(b => b.data !== data || b.tipo !== tipo || b.emailUsuario !== emailUsuario); } batidas.push(batida); localStorage.setItem(storageKeyBatidas, JSON.stringify(batidas)); alert('Lançamento salvo com sucesso!'); fecharTodosPaineis(); formLancamento.reset(); });

            // Bater Ponto
            btnBaterPonto.addEventListener('click', () => {
                let proximoPonto = null;
                if (timeSpans.entrada.textContent === '--:--') proximoPonto = 'entrada';
                else if (timeSpans.pausa.textContent === '--:--') proximoPonto = 'pausa';
                else if (timeSpans.retorno.textContent === '--:--') proximoPonto = 'retorno';
                else if (timeSpans.saida.textContent === '--:--') proximoPonto = 'saida';
                else { alert('Todos os seus pontos de hoje já foram registrados!'); return; }
                btnBaterPonto.disabled = true;
                loadingText.style.display = 'block';
                const agora = new Date();
                const horaFormatada = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const dataFormatada = new Date(agora.getTime() - (agora.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                if (!navigator.geolocation) { alert('Geolocalização não é suportada pelo seu navegador.'); habilitarBotaoPonto(); return; }
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        let localizacaoFormatada = `Lat/Long: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
                        try {
                            const urlApi = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18`;
                            const response = await fetch(urlApi);
                            const data = await response.json();
                            if (data && data.address) {
                                const rua = data.address.road || data.address.pedestrian || "";
                                const bairro = data.address.suburb || data.address.neighbourhood || "";
                                const cidade = data.address.city || data.address.town || "";
                                if (rua && bairro) localizacaoFormatada = `${rua}, ${bairro} - ${cidade}`;
                                else if (data.display_name) localizacaoFormatada = data.display_name;
                            }
                        } catch (error) { console.error("Erro ao buscar endereço:", error); }
                        timeSpans[proximoPonto].textContent = horaFormatada;
                        cards[proximoPonto].classList.add('completed');
                        const batida = { emailUsuario: dadosUsuario.email, data: dataFormatada, tipo: proximoPonto, hora: horaFormatada, local: localizacaoFormatada };
                        let batidas = JSON.parse(localStorage.getItem(storageKeyBatidas)) || [];
                        const jaExiste = batidas.find(b => b.data === dataFormatada && b.tipo === proximoPonto && b.emailUsuario === dadosUsuario.email);
                        if (!jaExiste) { batidas.push(batida); localStorage.setItem(storageKeyBatidas, JSON.stringify(batidas)); }
                        if (proximoPonto === 'pausa') { const horaRetorno = new Date(agora.getTime() + dadosUsuario.jornada.almoco * 60000); retornoPrevistoEl.textContent = `Previsto: ${horaRetorno.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`; }
                        if (proximoPonto === 'retorno') { retornoPrevistoEl.textContent = ""; }
                        alert(`Ponto de ${proximoPonto.toUpperCase()} registrado!\n\nHora: ${horaFormatada}\nLocalização: ${localizacaoFormatada}`);
                        habilitarBotaoPonto();
                        verificarStatusJornada();
                        atualizarWidgets();
                    },
                    (error) => { alert('Erro ao obter localização. Ponto não registrado!'); habilitarBotaoPonto(); },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });

            function carregarBatidasDoDia() { const agora = new Date(); const dataFormatada = new Date(agora.getTime() - (agora.getTimezoneOffset() * 60000)).toISOString().split('T')[0]; let batidas = JSON.parse(localStorage.getItem(storageKeyBatidas)) || []; const minhasBatidasHoje = batidas.filter(b => b.emailUsuario === dadosUsuario.email && b.data === dataFormatada); minhasBatidasHoje.forEach(batida => { if (timeSpans[batida.tipo]) { timeSpans[batida.tipo].textContent = batida.hora; cards[batida.tipo].classList.add('completed'); } }); }
            function atualizarWidgets() {
                let solicitacoes = JSON.parse(localStorage.getItem(storageKeySolicitacoes)) || [];
                let usuarios = JSON.parse(localStorage.getItem(storageKeyUsuarios)) || [];
                const totalFunc = usuarios.length;
                widgetTotalFunc.textContent = totalFunc;

                const pendentes = solicitacoes.filter(s => s.status === 'pendente'); // CORREÇÃO: Sem filtro de usuário
                widgetAjustesPendentes.textContent = pendentes.length;

                let batidas = JSON.parse(localStorage.getItem(storageKeyBatidas)) || [];
                let jornadas = JSON.parse(localStorage.getItem(storageKeyJornadas)) || [];
                let saldoEmpresaMinutos = 0;
                const funcionarios = usuarios.filter(u => u.email !== dadosUsuario.email);

                funcionarios.forEach(func => {
                    const jornadaDoFuncionario = jornadas.find(j => j.nome === func.jornada);
                    const batidasFuncionario = batidas.filter(b => b.emailUsuario === func.email);
                    if (jornadaDoFuncionario && batidasFuncionario.length > 0) {
                        const batidasPorDia = {};
                        batidasFuncionario.forEach(b => { if (!batidasPorDia[b.data]) batidasPorDia[b.data] = {}; batidasPorDia[b.data][b.tipo] = b.hora; });
                        Object.keys(batidasPorDia).forEach(data => {
                            const dia = batidasPorDia[data];
                            const dataObj = new Date(data + 'T12:00:00');
                            const diaDaSemana = dataObj.getDay();
                            let jornadaEsperadaMin = 0;
                            if (diaDaSemana === 5) { jornadaEsperadaMin = (horaParaMinutos(jornadaDoFuncionario.fimSexta) - horaParaMinutos(jornadaDoFuncionario.inicioSexta)) - jornadaDoFuncionario.almoco; } else if (diaDaSemana !== 0 && diaDaSemana !== 6) { jornadaEsperadaMin = (horaParaMinutos(jornadaDoFuncionario.fim) - horaParaMinutos(jornadaDoFuncionario.inicio)) - jornadaDoFuncionario.almoco; }
                            if (isNaN(jornadaEsperadaMin)) jornadaEsperadaMin = 0;
                            let totalTrabalhadoMin = 0;
                            if (dia.entrada && dia.saida) { const entrada = horaParaMinutos(dia.entrada); const saida = horaParaMinutos(dia.saida); const pausa = horaParaMinutos(dia.pausa); const retorno = horaParaMinutos(dia.retorno); const tempoPausa = (retorno > 0 && pausa > 0) ? (retorno - pausa) : 0; totalTrabalhadoMin = (saida - entrada) - tempoPausa; }
                            saldoEmpresaMinutos += (totalTrabalhadoMin - jornadaEsperadaMin);
                        });
                    }
                });

                widgetSaldoEmpresa.textContent = minutosParaHora(saldoEmpresaMinutos);
                if (saldoEmpresaMinutos > 0) { widgetSaldoEmpresa.className = 'value saldo-positivo'; } else if (saldoEmpresaMinutos < 0) { widgetSaldoEmpresa.className = 'value saldo-negativo'; } else { widgetSaldoEmpresa.className = 'value'; }
            }

            // Lógica Dropdown RH
            document.querySelectorAll('.sidebar-nav .dropdown-toggle').forEach(item => { item.addEventListener('click', event => { event.preventDefault(); const parentLi = item.parentElement; const submenu = parentLi.querySelector('.dropdown-menu'); document.querySelectorAll('.sidebar-nav li.open').forEach(li => { if (li !== parentLi) { li.classList.remove('open'); li.querySelector('.dropdown-menu').style.display = 'none'; } }); if (parentLi.classList.contains('open')) { parentLi.classList.remove('open'); submenu.style.display = 'none'; } else { parentLi.classList.add('open'); submenu.style.display = 'block'; } }); });

            carregarBatidasDoDia();
            verificarStatusJornada();
            atualizarWidgets();
            setInterval(verificarStatusJornada, 60000);
            

        });
    </script>

    <script>
        (function () {
            // Lógica do Tema
            const toggle = document.getElementById('theme-toggle');
            const body = document.body;
            const themeKey = 'theme_preference_smartponto';
            const preferenciaSalva = localStorage.getItem(themeKey);
            if (preferenciaSalva === 'dark') { body.classList.add('dark-mode'); toggle.checked = true; }
            toggle.addEventListener('change', function () { if (this.checked) { body.classList.add('dark-mode'); localStorage.setItem(themeKey, 'dark'); } else { body.classList.remove('dark-mode'); localStorage.setItem(themeKey, 'light'); } });
             btnLogout.addEventListener('click', (event) => { event.preventDefault(); localStorage.removeItem('sessao_usuario_atual'); window.location.href = 'index.html'; });
        })();
    </script>
</body>


</html>

